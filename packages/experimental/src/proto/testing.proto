//
// Copyright 2020 DXOS.org
//

syntax = "proto3";

package dxos.echo.testing;

import "google/protobuf/any.proto";

//
// Typescript Note:
// Use the interface name in code (e.g., IFeedEvenlope) and the concrete class name in the __type_url reference.
//

//
// Feeds
//

// Outer message type decoded by Codec.
// NOTE: Hypercore returns a field called `data`, which corresponds to this envelope (not the contained message).
message FeedMessage {
  FeedGenesis genesis = 1;
  HaloEnvelope halo = 2;
  EchoEnvelope echo = 3;
}

// Must be the first (zeroth) block in each feed.
message FeedGenesis {
  // Defined by genesis feed.
  PartyGenesis partyGenesis = 1;
}

// Non-persistent metadata.
message FeedMeta {
  int32 seq = 1;
  bytes feedKey = 2;
  bytes identityKey = 3;
}

// Wrapped feed message.
message FeedStream {

  // Non-persistent metadata.
  FeedMeta meta = 1;

  // Feed payload object (above).
  FeedMessage data = 2;
}

//
// HALO
//

// Wrapper for all HALO messages.
message HaloEnvelope {
  oneof action {
    PartyAdmit admit = 1;
    PartyEject eject = 2;
  }
}

// Indicates creation of a party.
message PartyGenesis {
  bytes feedKey = 1;
}

// Admit to party.
message PartyAdmit {
  bytes feedKey = 1;
}

// Reject from party.
message PartyEject {
  bytes feedKey = 1;
}

//
// ECHO
//

// Wrapper for all ECHO messages.
message EchoEnvelope {
  VectorTimestamp timestamp = 1;
  string itemId = 2;

  oneof action {
    ItemGenesis genesis = 10;
    ItemMutation itemMutation = 11;
    google.protobuf.Any dataMutation = 12;
  }
}

// Item creation.
message ItemGenesis {
  string itemType = 1;
  string modelType = 2;
  string modelVersion = 3;
}

message ItemMutation {
  string key = 1;
  string value = 2;
}

// Vector timestamp used to order messages.
message VectorTimestamp {
  message Part {
    // TODO(burdon): Remove (see below)?
    bytes feedKey = 1;
    // TODO(burdon): Determine if admit DAG can be ordered. Requires party messages to be ordered (by lexical feed key).
    int32 feedIndex = 2;
    int32 seq = 3;
  }

  repeated Part timestamp = 1;
}

//
// Testing
//

message TestMessage {
  int32 value = 1;
}
